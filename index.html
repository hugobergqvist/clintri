<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClinTri - Visualization of Clinical Trials</title>

    <link rel="stylesheet" type="text/css" href="css/newMain.css">
    <link rel="stylesheet" type="text/css" href="css/loader.css">
    <link rel="stylesheet" type="text/css" href="css/phaseListStyle.css">
    <link rel="stylesheet" type="text/css" href="css/errormessage.css">
    <link rel="stylesheet" type="text/css" href="css/breadcrumbs.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:200,300,400,500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300,400,500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>
</head>

<body>
    <div id="logo" class="header">
        <a href="index.html"><img src="./images/logo.svg" class="clintri-logo" alt="ClinTri" /></a>
    </div>

    <div id="logo-extend" class="header">
        <div id="logo-border" style="width:1px; height:50px; background-color: black;"></div>
        <div style="padding-top:5px">
            <span style="font-weight: 400; font-size: 20px; line-height: 0px;">Clinical trials information
                visualization</span>
            <br />
            <span style="font-size: 15px; font-weight: 200;">Based on 300 000+ medical trials</span>
        </div>
    </div>

    <div id="extra" class="header"></div>

    <div id="search-bar" class="">
        <form id="search-form" onsubmit="return false">
            <input id="search-input-text" type="text" placeholder="e.g. breast cancer">
            <input type="submit" onclick="createSankeytree(document.getElementById('search-input-text').value)"
                style="position: absolute; visibility: hidden;">
            <img src="./images/search_icon.svg" class="search-button"
                onclick="createSankeytree(document.getElementById('search-input-text').value)"
                style="position: absolute; right: 25px; align-self: center;" />
            <span
                style="position: absolute; margin-top: -10px; margin-left: 10px; font-family: 'Bitter', serif;">Condition</span>
        </form>

    </div>
    <div id="filter" class="header">
        <div class="filter-hidden" id="filter-button" onclick="toggleFilter()">

            <svg class="" id="filter_icon" xmlns="http://www.w3.org/2000/svg" width="34.568" height="38.043"
                viewBox="0 0 34.568 38.043">
                <g id="noun_Settings_943929" transform="translate(-11.2 -7.3)">
                    <g id="Group_13" data-name="Group 13" transform="translate(11.2 7.3)">
                        <path id="Path_44" data-name="Path 44"
                            d="M44.12,40.921H40.735A5.92,5.92,0,0,0,35.077,36.6a6.07,6.07,0,0,0-5.7,4.321H12.848a1.648,1.648,0,0,0,0,3.3H29.375a5.864,5.864,0,0,0,11.315,0h3.386a1.644,1.644,0,0,0,1.648-1.648A1.58,1.58,0,0,0,44.12,40.921Zm-9.043,4.321A2.68,2.68,0,0,1,32.4,42.569a2.673,2.673,0,0,1,5.346,0A2.68,2.68,0,0,1,35.077,45.242Z"
                            transform="translate(-11.2 -23.548)" />
                        <path id="Path_45" data-name="Path 45"
                            d="M12.848,14.918h3.519a5.864,5.864,0,0,0,11.315,0H44.12a1.644,1.644,0,0,0,1.648-1.648,1.617,1.617,0,0,0-1.648-1.648H27.682a5.864,5.864,0,0,0-11.315,0H12.848A1.644,1.644,0,0,0,11.2,13.269,1.617,1.617,0,0,0,12.848,14.918ZM22.025,10.6A2.68,2.68,0,0,1,24.7,13.269a2.625,2.625,0,0,1-2.673,2.673,2.68,2.68,0,0,1-2.673-2.673A2.74,2.74,0,0,1,22.025,10.6Z"
                            transform="translate(-11.2 -7.3)" />
                        <path id="Path_46" data-name="Path 46"
                            d="M44.12,70.221H27.682a5.864,5.864,0,0,0-11.315,0H12.848A1.644,1.644,0,0,0,11.2,71.869a1.617,1.617,0,0,0,1.648,1.648h3.519a5.864,5.864,0,0,0,11.315,0H44.12a1.644,1.644,0,0,0,1.648-1.648A1.617,1.617,0,0,0,44.12,70.221Zm-22.1,4.321a2.68,2.68,0,0,1-2.673-2.673,2.673,2.673,0,1,1,5.346,0A2.68,2.68,0,0,1,22.025,74.542Z"
                            transform="translate(-11.2 -39.795)" />
                    </g>
                </g>
            </svg>
        </div>
    </div>
    <div id="navigationBreadcrumbs">
        <ul class="breadcrumb">
            <li id="breadcrumbHome" onclick="GoToHome()" class="home">Home</li>
            <li id="breadcrumbSankey" onclick="GoToSankeyTree()" class="hideBreadcrumb">{Sankeytree}</li>
            <li id="breadcrumbList" class="hideBreadcrumb">{List}</li>
            <!-- <li id="breadcrumbStudy" class="hideBreadcrumb">{study}</li> -->
        </ul>
    </div>
    <div class="wrapper" id="content">
        <div id="errorMessage" class="showMessage hideMessage">
            <h1 id="errortext">Condition was not found :( <br /> Please retry with another condition!</h1>
        </div>
        <div id="loader" class="loader hideLoader"><img src="./images/Pulse-1s-200px.gif" alt="loader">
            <div id="loaderCounter"></div>
        </div>

        <div id="tooltip" class="hidden">
            <p><strong id="name"></strong></p>
            <p><span id="value"></span></p>
        </div>
        <!-- <svg id="svgtest"></svg> THIS IS WHAT WILL CONTAIN THE SUNBURST LATER ON!! -->
        <div id="treeMapContainer"></div>
        <div id="sankeyContainer"></div>
        <div id="phaseContentListContainer">
            <table id="phaseTable">
                <thead id="phaseTableHeader">
                    <tr>
                        <th><span id="studyTitle">Study Title </span><input id="studySearch" type="text" value=""
                                placeholder="key search" style="margin-left: 200px;"></input></th>
                        <th>Start Date</th>
                    </tr>
                </thead>
                <tbody id="phaseTableBody">
                    <tr>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="singleStudy">
            <div class="container" style="padding: 10px;">
            <h2 id="singleStudyTitle">Name of study</h2>
            <p class="singleStudyParagraph"><strong>Start date: </strong><span id="singleStudyStartDate"></span></p>
            <p class="singleStudyParagraph"><strong>End date: </strong><span id="singleStudyEndDate"></span></p>
            <p class="singleStudyParagraph"><strong>Current status: </strong><span id="singleStudyStatus"></span></p>
            <p class="singleStudyParagraph"><strong>Enrollment count: </strong><span id="singleStudyEnrollmentCount"></span></p>
            <p class="singleStudyParagraph"><strong>Gender: </strong><span id="singleStudyGender"></span></p>
            <p class="singleStudyParagraph"><strong>Organization: </strong><span id="singleStudyOrganization"></span></p>
            <p class="singleStudyParagraph"><strong>Description: </strong><span id="singleStudyDescription"></span></p>
            <button><a id="goToWebsiteButton" target="_blank">Go to full study</a></button>
        </div>
        </div>
    </div>

    </div>
    <div class="filter" id="filter-wrapper">
        <br />
        <p style="color: white">intervalStart: March, 2016</p>
        <p style="color: white">intervalEnd: April, 2017</p>
        <button onclick="updateSankeyTree()">Filter</button>
        <span style="color: white; text-align: center; margin-left: 20px; font-family: 'Bitter', serif;">TODO:
            Filter</span>
    </div>
    <!-- Wrapper div contains the treemap -->
    <div id="sankeyTreeWrapper"></div>

    <script src="script/fetchSingleStudy.js"></script>
    <script src="script/handlingdata.js"></script>
    <script src="script/sankeyTree.js"></script>
    <script src="script/handleSankeytreeData.js"></script>
    <script src="script/createPhaseList.js"></script>
    <script src="script/sunburst.js"></script>
    <script src="script/index.js"></script>
    <div id="timeline">

        <canvas id="canvas2"></canvas>
        <canvas id="canvas"></canvas>
    </div>
</body>

<script>
    document.addEventListener("DOMContentLoaded", modifyIncomingData);    
</script>



<script>

    const ratio = window.devicePixelRatio;
    const c = document.getElementById("canvas");
    const c2 = document.getElementById("canvas2");

    const ctx = c.getContext("2d");
    const ctx2 = c2.getContext("2d");


    c.width = window.innerWidth * ratio;
    c.height = 75 * ratio;
    c.style.width = window.innerWidth + 'px';
    c.style.height = '75px';
    c.style.position = "absolute";


    c2.width = window.innerWidth * ratio;
    c2.height = 75 * ratio;
    c2.style.width = window.innerWidth + 'px';
    c2.style.height = 75;
    c2.style.position = "absolute";

    ctx.scale(ratio, ratio);
    ctx2.scale(ratio, ratio);

    const rect = c.getBoundingClientRect();
    var mousePos = { x: 0, y: 0 }
    var isMovingLeft = false;
    var isMovingRight = false;
    var leftMark = { x: 10 };
    var rightMark = { x: window.innerWidth-10};

    var divWidth = window.innerWidth-20;
    var scaleMarks = {start: 10+10, stop: 10}

    
    var startDate = new Date(1995,1,1,0,0,0)
    var endDate = new Date(2020,1,0,0,0)
    var currentDate = new Date();
    var spanYears = currentDate.getYear()-startDate.getYear();
    var spanMilliSecond = currentDate-startDate;

    var pixelsPerYear = divWidth / (endDate.getYear()-startDate.getYear())
    console.log("date:", divWidth/pixelsPerYear)

    var startYear = 1995;
    var endYear = 2020;


    function initCanvas() {

        drawMarker();
    }

    function drawScale() {

        var stepsDist = divWidth/spanYears;
        var stepDistSmall = stepsDist/6;
        for(var i = 0; i < spanYears; i++ ){
        ctx2.beginPath();
        if( leftMark.x < divWidth - 18 - (i*stepsDist) && rightMark.x > divWidth - 18 - (i*stepsDist)){
            ctx2.fillStyle ="rgba(47,47,47,1)";
        }else{
            ctx2.fillStyle ="rgba(183,183,183,1)";        
        }
        
        ctx2.fillRect(divWidth-18 - (i*stepsDist),0,2,20);
        //ctx2.fillRect(scaleMarks.start + (i*stepsDist),0,2,20);
        ctx2.closePath();
        ctx2.font = "14px Comfortaa";
        ctx2.textAlign = "center"; 
        ctx2.fillText(endYear-(i*1), divWidth - 18 - (i*stepsDist), 36);  
        //ctx2.fillText(startYear+(i*1), 6+(i*stepsDist), 36);  
                
            for(var x=0; x<6; x++){
                if(divWidth - 18 - (i*stepsDist)-(x*stepDistSmall) > spanYears){
                    ctx2.beginPath();
                if( leftMark.x < divWidth - 18 - (i*stepsDist) - (x*stepDistSmall) && rightMark.x > divWidth - 18 - (i*stepsDist) - (x*stepDistSmall)){
                    ctx2.fillStyle ="rgba(47,47,47,1)";
                }else{
                    ctx2.fillStyle ="rgba(183,183,183,1)";
                }
                ctx2.fillRect(divWidth - 18 - (i*stepsDist)-(x*stepDistSmall),0,1,15);
                //ctx2.fillRect(scaleMarks.start + (i*stepsDist)+(x*stepDistSmall),0,1,15);
                ctx2.closePath();
                }
                
            }
        }




    }

    function drawMarker() {

        drawScale();
        ctx.beginPath();
        ctx.fillStyle = "#38729F";
        ctx.fillRect(leftMark.x, 0, 6, 55);
        ctx.fillRect(rightMark.x-6, 0, 6, 55);
        ctx.closePath();

        ctx.beginPath();
        ctx.strokeStyle = "#38729F";
        ctx.lineWidth = 4;
        ctx.moveTo(leftMark.x, 1);
        ctx.lineTo(rightMark.x, 1);
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.lineWidth = 14;
        ctx.moveTo(leftMark.x, 55);
        ctx.lineTo(rightMark.x , 55);
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.moveTo(leftMark.x + 6, 18);
        ctx.lineTo(leftMark.x + 16, 26);
        ctx.lineTo(leftMark.x + 6, 34);
        ctx.fill();
        ctx.closePath();

        ctx.beginPath();
        ctx.moveTo(rightMark.x-6, 18);
        ctx.lineTo(rightMark.x-16, 26);
        ctx.lineTo(rightMark.x-6, 34);
        ctx.fill();
        ctx.closePath();

    }

    c.addEventListener("mousemove", e => {
        mousePos.x = e.clientX - rect.left;
        mousePos.y = e.clientY - rect.top;

        // console.log("span: ", leftMark.x, rightMark.x)

        if (isMovingLeft === true) {


            leftMark.x = mousePos.x;
            //document.getElementById('content').innerHTML = leftMark.x + "-" + rightMark.x;

            ctx.clearRect(0, 0, 2000, 2000);
            ctx2.clearRect(0, 0, 2000, 2000);
            drawMarker();
            updateSankey()
        }
        if (isMovingRight === true) {
            rightMark.x = mousePos.x;
            //document.getElementById('content').innerHTML = leftMark.x + "-" + rightMark.x;

            ctx.clearRect(0, 0, 2000, 2000);
            ctx2.clearRect(0, 0, 2000, 2000);
            drawMarker();
            updateSankey()
        }
        
    });

    c.addEventListener("mousedown", e => {
        if (Math.abs(mousePos.x - leftMark.x) < 10) {
            isMovingLeft = true;
        }

        if (Math.abs(mousePos.x - rightMark.x) < 10) {
            isMovingRight = true;
        }

    })

    const updateSankey = () => {

        /*
        let end = new Date()
        let start = new Date()
        start.setDate(start.getDate() - (1000000 / leftMark.x) )
        end.setDate(end.getDate() + (rightMark.x  * 1.1) )
        */

        var leftMarkerYear = (divWidth - 18 - leftMark.x) / pixelsPerYear
        var rightMarkerYear = (divWidth - 18 - rightMark.x) / pixelsPerYear
        var leftMarkMonth = Math.round(12*(1-(leftMarkerYear % 1)));
        var rightMarkMonth = Math.round(12*(1-(rightMarkerYear % 1)));

        var start = new Date(2020 - Math.ceil(leftMarkerYear),leftMarkMonth,0,0,0);
        var end = new Date(2020 - Math.ceil(rightMarkerYear), rightMarkMonth,0,0,0)
        //console.log("start", start);
        //console.log("end", end)
        /*
        console.log("Left:", leftMark.x)
        console.log("Right:", rightMark.x)
        console.log("Pixels per year:", pixelsPerYear)
        console.log("Left Year:", 2020 - Math.ceil(leftMarkerYear))
        console.log("Right Year:", 2020 - Math.ceil(rightMarkerYear))
        console.log("Left Month:", leftMarkMonth)
        console.log("Right Month:", rightMarkMonth)
        console.log()
        */
        timeFilterSankeyTree(start, end )
    }   


    c.addEventListener("mouseup", e => {
        isMovingLeft = false;
        isMovingRight = false;
        //updateSankey()

    })

    initCanvas();
</script>

<script>
    function toggleFilter() {
        document.getElementById("filter-button").classList.toggle("filter-show");
        document.getElementById("filter_icon").classList.toggle("turnWhite");
        //document.getElementById("categorieContainer").classList.toggle("filter-window");
        //document.getElementById("content").classList.toggle("wrapperActiveFilter");
        document.getElementById("filter-wrapper").classList.toggle("show-filter");



        //console.log(document.getElementById("content"))
        //document.getElementById("content").classList.toggle("wrapperActiveFilter");
    }

    //function searchSubmit(searchValue) {
        //document.getElementById('content').innerHTML = searchValue;
    //}
</script>
</body>

</html>